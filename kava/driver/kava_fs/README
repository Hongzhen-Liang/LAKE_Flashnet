KAvA file system applications
=============================

Eryptfs
-------

!!! Install kernel 4.19

Configure the kernel to enable ecryptfs module.

```
CONFIG_ECRYPT_FS=m
CONFIG_ECRYPT_FS_MESSAGING=y
```

In the kernel source, change the crypto algorithm to be `ecb` for fair comparison:

```
linux-4.19/fs/ecryptfs/crypto.c:601
linux-4.19/fs/ecryptfs/crypto.c:1583
```

!!! Setup ecryptfs

After booting into the new kernel, set up ecryptfs utilities and encrypted directory
(`~/crypt` does not have to be under the home directory):

```
$ sudo apt install ecryptfs-utils
$ mkdir ~/.ecryptfs ~/crypt
$ cd ~/crypt
$ mkdir .secret secret
$ touch ~/.ecryptfs/secret.conf ~/.ecryptfs/secret.sig
$ echo "$HOME/crypt/.secret $HOME/crypt/secret ecryptfs" > ~/.ecryptfs/secret.conf
$ ecryptfs-add-passphrase
Passphrase: 111
Inserted auth tok with sig [1014d20ded49c7d8] into the user session keyring
$ echo 1014d20ded49c7d8 > .ecryptfs/secret.sig
```

Replace the signature with yours. To mount the ecryptfs FS, in `~/crypt` run:

```
$ echo "111" | ecryptfs-add-passphrase
$ mount.ecryptfs_private secret
```

Unmount the FS by:

```
$ umount.ecryptfs_private secret
```

Without loading KAvA's ecryptfs module and unloading AES-NI module, the vanilla
ecryptfs will use AES-NI to accelerate the AES-ECB crypto.
To disable the hardware acceleration, unload the AES-NI module before mounting the
ecryptfs FS.

```
$ sudo modprobe -r aesni_intel
```

To use KAvA's ecryptfs:

```
# Start KAvA
kava/scripts $ ./load_all.sh

# Load ecryptfs
kava/driver/kava-benchmarks/fs/ecryptfs $ ./unload.sh ; ./load.sh

# Mount ecryptfs
~/crypt $ echo "111" | ecryptfs-add-passphrase && mount.ecryptfs_private secret
```

!!! Stop KAvA

```
# Unmount ecryptfs
umount.ecryptfs_private secret
sudo modprobe -r ecryptfs
sudo rmmod ecryptfs
sudo modprobe -r kava_ecb
sudo rmmod kava_ecb

# Stop KAvA
kava/scripts $ ./unload_all.sh
```

!!! Test throughput

In `kava/driver/kava-benchmarks/fs/file_io`, run:

```
$ make
$ ./run.sh
```

The script executes `sudo ./fs_bench ~/crypt/secret/ 1 1M 256K`.
Sudo is required for flushing the caches.
The three parameters mean `repeated times`, `file size` and `R/W block size`.

Run benchmarks
--------------

!!! CUDA version

In `crypt` directory, execute:

```
$ sudo modprobe -r aesni_intel
$ echo "111" | ecryptfs-add-passphrase
$ mount.ecryptfs_private secret
```

Change the block size (and file size) in `file_io/run.sh`, and run the benchmark:

```
$ ./run.sh ~/crypt/secret
```

Then unmount the ecryptfs partition:

```
$ umount.ecryptfs_private secret
```

!!! KAvA version

Set read ahead block size (in KB); the size should be same or larger than the
R/W block size:

```
# echo 4096 > /sys/block/sdb/queue/read_ahead_kb
```

Start KAvA in `$KAVA_ROOT`:

```
$ ./scripts/load_all.sh
```

Install KAvA ecb and ecryptfs modules in `ecryptfs`:

```
$ ./load.sh
```

In `crypt` directory, execute:

```
$ echo "111" | ecryptfs-add-passphrase
$ mount.ecryptfs_private secret
```

Then run the `file_io` benchmarks. To uninstall the modules:

```
crypt$ umount.ecryptfs_private secret
ecryptfs$ ./unload.sh
KAVA_ROOT$ Ctrl+C
```

!!! KAvA + AES-NI version

Change the `aesni_fraction` parameter in `fs/ecryptfs/load.sh` to a number between 1-9:

```
sudo insmod kava_ecb.ko split_threshold=512 aesni_fraction=50
```

!!! CPU/GPU utilizations

1. CPU utilization.
    In `kava-benchmarks/scripts`, run
    ````
    python3 fetch_cpu_stat.py -n fs_bench -o cpu_stats -p _fs
    ```

2. CPU and GPU utilization.
    Run
    ````
    python3 fetch_cpu_stat.py -n fs_bench worker kavad kava_aesni_crypt -g -o cpu_stats -p _fs
    ```

3. Parse stats.
    ```
    python3 post_process_cpu_stat.py -i cpu_stats_fs.txt -o cpu_utils_fs.csv
    ```
