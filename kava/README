# Troubleshoot

kava REQUIRES cma as kernel parameter. Please add `cma=128M@0-4G log_buf_len=16M` to the cmdline.

Check if these are in the kernel config (`emacs /boot/config-$(uname -r)`) otherwise recompile.
CONFIG_CMA=y
CONFIG_CMA_AREAS=7
CONFIG_DMA_CMA=y
CONFIG_CMA_SIZE_MBYTES=32
CONFIG_CMA_SIZE_SEL_MBYTES=y
CONFIG_CMA_ALIGNMENT=8
CONFIG_INPUT_CMA3000=m
CONFIG_INPUT_CMA3000_I2C=m


## Code and system structure

```
|____include [ Headers ]
|____core    [ Core infrastructure for all klib implementations ]
|____driver  [ Kernel modules that utilize the in-kernel accelerator framework ]
|____klib    [ Accelerator framework API in kernel space ]
|____worker  [ User-space server and worker that communicate with accelerator ]

    |                            [worker]
user|                             ^    |
----------------------------------|----|--
    |                             |    |
kern|  [driver] --> [klib] --> [core]  |
---------------------------------------|--
                                       v
                                     [hw]
```

`[Core]` works as the command handler and transport channel in AvA.
The goal is to implement as many as optimizations in `[core]`,
instead of in `[driver]` or `[klib]` to be driver-specific or API-specific:

* Mmap shared memory
* Zero-copy
* Batching (huge buffer allocation)
* Upcall and downcall (socket, ioctl spin, mmap, signal, etc.)

For sake of simplicity, we keep these restrictions in the current implementation:

* Each kernel driver only has one worker, connected by one command channel.
* Only one klib module for each framework is installed, and it only has one channel mode enabled.

## Ideas

### API verification

An API verifier should locate between `[driver]` and `[klib]`,
which verifies all APIs with arguments invoked by `[driver]`.
The verifier should check all memory accesses of the API to fall in the `[driver]`'s buffers.

### Safety

`[Klib]` and `[core]` should protect kernel from crash and blocking (busy waiting).
